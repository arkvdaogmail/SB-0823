<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase File Management System</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #6e8efb, #a777e3);
            color: white;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .search-section {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
        }

        .search-form {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        input, button {
            padding: 12px 15px;
            border-radius: 6px;
            border: 1px solid #ddd;
            font-size: 16px;
        }

        input {
            flex: 1;
            min-width: 200px;
        }

        button {
            background-color: #6e8efb;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #5a7df9;
        }

        .results-section {
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background-color: #f8f9fa;
            font-weight: 600;
        }

        tr:hover {
            background-color: #f8f9ff;
        }

        .action-btn {
            padding: 8px 12px;
            margin: 0 5px;
            border-radius: 4px;
            font-size: 14px;
        }

        .download-btn {
            background-color: #28a745;
        }

        .download-btn:hover {
            background-color: #218838;
        }

        .preview-btn {
            background-color: #17a2b8;
        }

        .preview-btn:hover {
            background-color: #138496;
        }

        .status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 6px;
            text-align: center;
        }

        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* File Preview Modal */
        #filePreviewModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        #filePreviewContent {
            background-color: white;
            max-width: 90%;
            max-height: 90%;
            overflow: auto;
            padding: 30px;
            border-radius: 10px;
            position: relative;
            width: 90%;
            height: 80%;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
        }

        #closePreview {
            position: absolute;
            top: 15px;
            right: 15px;
            cursor: pointer;
            font-size: 28px;
            color: #aaa;
            background: none;
            border: none;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #closePreview:hover {
            color: #ff0000;
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .preview-title {
            font-size: 1.5rem;
            color: #333;
        }

        .preview-body {
            height: calc(100% - 70px);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .preview-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .preview-text {
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: monospace;
            max-height: 100%;
            overflow: auto;
            width: 100%;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }

        .preview-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .preview-audio, .preview-video {
            width: 100%;
            max-width: 600px;
        }

        .no-preview {
            padding: 30px;
            text-align: center;
            color: #6c757d;
            font-size: 1.2rem;
        }

        @media (max-width: 768px) {
            .search-form {
                flex-direction: column;
            }
            
            input, button {
                width: 100%;
            }
            
            th:nth-child(2), td:nth-child(2) {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Supabase File Management System</h1>
            <p>Search, preview, and download your files</p>
        </header>

        <section class="search-section">
            <div class="search-form">
                <input type="text" id="searchInput" placeholder="Search by document name..." />
                <button id="searchBtn">Search</button>
                <button id="viewAllBtn">View All</button>
            </div>
        </section>

        <div id="statusMessage" class="status"></div>

        <section class="results-section">
            <table id="resultsTable">
                <thead>
                    <tr>
                        <th>Document Name</th>
                        <th>File Path</th>
                        <th>Created At</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="resultsBody">
                    <!-- Results will be populated here -->
                </tbody>
            </table>
        </section>

        <!-- File Preview Modal -->
        <div id="filePreviewModal">
            <div id="filePreviewContent">
                <button id="closePreview">&times;</button>
                <div class="preview-header">
                    <h2 class="preview-title" id="previewFileName"></h2>
                    <button id="downloadPreviewBtn" class="action-btn download-btn">Download</button>
                </div>
                <div class="preview-body" id="previewContainer"></div>
            </div>
        </div>
    </div>

    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://mfrefbmnxygeahaluhzr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1mcmVmYm1ueHlnZWFoYWx1aHpyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI1NDIxOTUsImV4cCI6MjA2ODExODE5NX0.Ur3hl7rVEWk6U-ydNbKymFmXtxUlx6RTn0pU0EnP7u0';
        
        // Initialize Supabase client
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // DOM elements
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const viewAllBtn = document.getElementById('viewAllBtn');
        const resultsTable = document.getElementById('resultsTable');
        const resultsBody = document.getElementById('resultsBody');
        const statusMessage = document.getElementById('statusMessage');
        const filePreviewModal = document.getElementById('filePreviewModal');
        const previewContainer = document.getElementById('previewContainer');
        const closePreview = document.getElementById('closePreview');
        const downloadPreviewBtn = document.getElementById('downloadPreviewBtn');
        const previewFileName = document.getElementById('previewFileName');
        
        // File type to icon and preview type mapping
        const fileTypeConfig = {
            'pdf': { 
                icon: 'üìÑ', 
                previewType: 'iframe',
                mimeType: 'application/pdf'
            },
            'txt': { 
                icon: 'üìù', 
                previewType: 'text',
                mimeType: 'text/plain'
            },
            'csv': { 
                icon: 'üìä', 
                previewType: 'text',
                mimeType: 'text/csv'
            },
            'jpg': { 
                icon: 'üñºÔ∏è', 
                previewType: 'image',
                mimeType: 'image/jpeg'
            },
            'jpeg': { 
                icon: 'üñºÔ∏è', 
                previewType: 'image',
                mimeType: 'image/jpeg'
            },
            'png': { 
                icon: 'üñºÔ∏è', 
                previewType: 'image',
                mimeType: 'image/png'
            },
            'gif': { 
                icon: 'üñºÔ∏è', 
                previewType: 'image',
                mimeType: 'image/gif'
            },
            'mp4': { 
                icon: 'üé•', 
                previewType: 'video',
                mimeType: 'video/mp4'
            },
            'webm': { 
                icon: 'üé•', 
                previewType: 'video',
                mimeType: 'video/webm'
            },
            'ogg': { 
                icon: 'üé•', 
                previewType: 'video',
                mimeType: 'video/ogg'
            },
            'mp3': { 
                icon: 'üîä', 
                previewType: 'audio',
                mimeType: 'audio/mp3'
            },
            'wav': { 
                icon: 'üîä', 
                previewType: 'audio',
                mimeType: 'audio/wav'
            },
            'default': { 
                icon: 'üìÅ', 
                previewType: 'unsupported',
                mimeType: 'application/octet-stream'
            }
        };

        // State variables
        let currentPreviewUrl = '';
        let currentPreviewFileName = '';

        // Event listeners
        searchBtn.addEventListener('click', handleSearch);
        viewAllBtn.addEventListener('click', handleViewAll);
        closePreview.addEventListener('click', closePreviewModal);
        downloadPreviewBtn.addEventListener('click', handleDownloadPreview);

        // Set status message
        function setStatus(message, type = 'info') {
            statusMessage.textContent = message;
            statusMessage.className = `status ${type}`;
        }

        // Handle search
        function handleSearch() {
            const searchTerm = searchInput.value.trim();
            if (searchTerm) {
                searchDocuments(searchTerm);
            } else {
                setStatus('Please enter a search term', 'error');
            }
        }

        // Handle view all
        function handleViewAll() {
            searchInput.value = '';
            searchDocuments('');
        }

        // Search documents
        async function searchDocuments(searchTerm = '') {
            try {
                setStatus('Searching...', 'info');
                
                let query = supabaseClient
                    .from('documents')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                if (searchTerm) {
                    query = query.ilike('document_name', `%${searchTerm}%`);
                }
                
                const { data, error } = await query;
                
                if (error) throw error;
                
                displayResults(data);
            } catch (error) {
                setStatus('Search failed: ' + error.message, 'error');
                console.error('Search error:', error);
            }
        }

        // Display results
        function displayResults(data) {
            if (!data || data.length === 0) {
                setStatus('No records found', 'info');
                resultsTable.style.display = 'none';
                return;
            }
            
            // Clear existing results
            resultsBody.innerHTML = '';
            
            // Add new results
            data.forEach(record => {
                const row = document.createElement('tr');
                
                // Format date
                const createdAt = new Date(record.created_at);
                const formattedDate = createdAt.toLocaleString();
                
                // Get file icon and extension
                const fileName = record.document_name;
                const fileExtension = fileName.split('.').pop().toLowerCase();
                const fileConfig = fileTypeConfig[fileExtension] || fileTypeConfig['default'];
                
                row.innerHTML = `
                    <td>${fileConfig.icon} ${record.document_name}</td>
                    <td>${record.file_path}</td>
                    <td>${formattedDate}</td>
                    <td>
                        <button class="action-btn download-btn" onclick="downloadFile('${record.file_path}', '${record.document_name}')">Download</button>
                        <button class="action-btn preview-btn" onclick="previewFile('${record.file_path}', '${record.document_name}')">Preview</button>
                    </td>
                `;
                
                resultsBody.appendChild(row);
            });
            
            resultsTable.style.display = 'table';
            setStatus(`Found ${data.length} record(s)`, 'success');
        }

        // Preview file
        async function previewFile(filePath, fileName) {
            try {
                setStatus('Loading preview...', 'info');
                
                // Get signed URL for the file
                const { data: signedUrlData, error: urlError } = await supabaseClient.storage
                    .from('documents')
                    .createSignedUrl(filePath, 60); // URL valid for 60 seconds
                    
                if (urlError) throw urlError;

                const fileExtension = fileName.split('.').pop().toLowerCase();
                const fileConfig = fileTypeConfig[fileExtension] || fileTypeConfig['default'];
                
                // Store current preview info for download
                currentPreviewUrl = signedUrlData.signedUrl;
                currentPreviewFileName = fileName;
                previewFileName.textContent = fileName;
                
                // Reset previous preview
                previewContainer.innerHTML = '';

                // Preview based on file type
                switch (fileConfig.previewType) {
                    case 'image':
                        const img = document.createElement('img');
                        img.src = signedUrlData.signedUrl;
                        img.classList.add('preview-image');
                        img.alt = fileName;
                        previewContainer.appendChild(img);
                        break;
                    
                    case 'text':
                        const response = await fetch(signedUrlData.signedUrl);
                        const text = await response.text();
                        const textPreview = document.createElement('pre');
                        textPreview.textContent = text;
                        textPreview.classList.add('preview-text');
                        previewContainer.appendChild(textPreview);
                        break;
                    
                    case 'iframe':
                        const iframe = document.createElement('iframe');
                        iframe.src = signedUrlData.signedUrl;
                        iframe.classList.add('preview-iframe');
                        previewContainer.appendChild(iframe);
                        break;
                    
                    case 'video':
                        const video = document.createElement('video');
                        video.src = signedUrlData.signedUrl;
                        video.controls = true;
                        video.classList.add('preview-video');
                        previewContainer.appendChild(video);
                        break;
                    
                    case 'audio':
                        const audio = document.createElement('audio');
                        audio.src = signedUrlData.signedUrl;
                        audio.controls = true;
                        audio.classList.add('preview-audio');
                        previewContainer.appendChild(audio);
                        break;
                    
                    default:
                        const notSupported = document.createElement('div');
                        notSupported.innerHTML = `
                            <div class="no-preview">
                                <p>Preview not supported for this file type</p>
                                <p>Use the download button to get the file</p>
                            </div>
                        `;
                        previewContainer.appendChild(notSupported);
                }

                // Show modal
                filePreviewModal.style.display = 'flex';
                setStatus('', 'info');

            } catch (error) {
                setStatus('Preview failed: ' + error.message, 'error');
                console.error('Preview error:', error);
            }
        }

        // Close preview modal
        function closePreviewModal() {
            filePreviewModal.style.display = 'none';
            previewContainer.innerHTML = '';
            currentPreviewUrl = '';
            currentPreviewFileName = '';
        }

        // Handle download from preview
        function handleDownloadPreview() {
            if (currentPreviewUrl && currentPreviewFileName) {
                downloadFileFromUrl(currentPreviewUrl, currentPreviewFileName);
            }
        }

        // Download file
        async function downloadFile(filePath, fileName) {
            try {
                setStatus('Preparing download...', 'info');
                
                // Get signed URL for the file
                const { data, error } = await supabaseClient.storage
                    .from('documents')
                    .createSignedUrl(filePath, 60); // URL valid for 60 seconds
                    
                if (error) throw error;
                
                downloadFileFromUrl(data.signedUrl, fileName);
                setStatus(`Downloading ${fileName}...`, 'success');
                
            } catch (error) {
                setStatus('Download failed: ' + error.message, 'error');
                console.error('Download error:', error);
            }
        }

        // Download file from URL
        function downloadFileFromUrl(url, fileName) {
            // Create a download link
            const downloadLink = document.createElement('a');
            downloadLink.href = url;
            downloadLink.download = fileName;
            
            // Trigger download
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
        }

        // Initialize by loading all documents
        searchDocuments('');
    </script>
</body>
</html>
